<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Учет заказов</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app-container">
    <!-- Бургер-кнопка -->
    <button class="burger-btn" onclick="toggleMenu()">☰</button>

    <!-- Затемнение фона -->
    <div class="overlay" onclick="toggleMenu()"></div>

    <!-- Боковое меню -->
    <nav class="sidebar">
      <h2>Меню</h2>
      <button onclick="showPage('add'); toggleMenu();">Добавить заказ</button>
      <button onclick="showPage('report'); toggleMenu();">Отчёты</button>
      <button onclick="showPage('ordersList'); toggleMenu();">Список заказов</button>
    </nav>

    <!-- Основной контент -->
    <main class="content">
      <div class="logo">
      <svg width="40%" height="2%" viewBox="0 0 56 13" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M5.03906 12.2031C4.1276 12.2031 3.34375 12.0208 2.6875 11.6562C2.03646 11.2865 1.53385 10.763 1.17969 10.0859C0.825521 9.40885 0.648438 8.59896 0.648438 7.65625V7.64844C0.648438 6.71094 0.822917 5.90365 1.17188 5.22656C1.52604 4.54427 2.02344 4.02083 2.66406 3.65625C3.30469 3.28646 4.0625 3.10156 4.9375 3.10156C5.8125 3.10156 6.57031 3.28125 7.21094 3.64062C7.85156 4 8.34635 4.50781 8.69531 5.16406C9.04427 5.82031 9.21875 6.59115 9.21875 7.47656V8.27344H2.02344V6.66406H7.90625L6.625 8.20312V7.10156C6.625 6.65885 6.55729 6.28906 6.42188 5.99219C6.28646 5.6901 6.09635 5.46094 5.85156 5.30469C5.61198 5.14844 5.33073 5.07031 5.00781 5.07031C4.6849 5.07031 4.40104 5.15104 4.15625 5.3125C3.91146 5.46875 3.71875 5.69792 3.57812 6C3.44271 6.30208 3.375 6.66927 3.375 7.10156V8.21875C3.375 8.64062 3.44271 9.0026 3.57812 9.30469C3.71354 9.60677 3.90885 9.83854 4.16406 10C4.42448 10.1562 4.73438 10.2344 5.09375 10.2344C5.40104 10.2344 5.65885 10.1875 5.86719 10.0938C6.08073 9.99479 6.2474 9.88542 6.36719 9.76562C6.49219 9.64583 6.57292 9.54948 6.60938 9.47656L6.63281 9.44531L9.16406 9.4375L9.14062 9.53125C9.08333 9.78646 8.96615 10.0703 8.78906 10.3828C8.61719 10.6901 8.36979 10.9818 8.04688 11.2578C7.72917 11.5339 7.32292 11.7604 6.82812 11.9375C6.33333 12.1146 5.73698 12.2031 5.03906 12.2031ZM13.0681 12.0156C11.9275 12.0156 11.1098 11.8281 10.615 11.4531C10.1202 11.0781 9.87281 10.4661 9.87281 9.61719V5.33594H8.54469V3.30469H9.87281V1.3125H12.6541V3.30469H14.3962V5.33594H12.6541V8.99219C12.6541 9.3151 12.7374 9.55729 12.9041 9.71875C13.0759 9.88021 13.3416 9.96094 13.7009 9.96094C13.8572 9.96094 13.9874 9.95833 14.0916 9.95312C14.1957 9.94271 14.2973 9.93229 14.3962 9.92188V11.9062C14.2504 11.9375 14.0577 11.9635 13.8181 11.9844C13.5837 12.0052 13.3337 12.0156 13.0681 12.0156ZM14.5347 12V0.0390625H17.3081V4.66406H17.4566C17.6493 4.1901 17.9566 3.8125 18.3784 3.53125C18.8055 3.24479 19.3264 3.10156 19.9409 3.10156C20.5816 3.10156 21.118 3.23177 21.5503 3.49219C21.9878 3.7474 22.3185 4.11979 22.5425 4.60938C22.7665 5.09375 22.8784 5.6849 22.8784 6.38281V12H20.105V7C20.105 6.47396 19.993 6.07031 19.7691 5.78906C19.5503 5.5026 19.2066 5.35938 18.7378 5.35938C18.4409 5.35938 18.1857 5.42969 17.9722 5.57031C17.7586 5.71094 17.5946 5.90625 17.48 6.15625C17.3654 6.40625 17.3081 6.69792 17.3081 7.03125V12H14.5347ZM27.1497 12.2031C26.2382 12.2031 25.4544 12.0208 24.7981 11.6562C24.1471 11.2865 23.6445 10.763 23.2903 10.0859C22.9361 9.40885 22.7591 8.59896 22.7591 7.65625V7.64844C22.7591 6.71094 22.9335 5.90365 23.2825 5.22656C23.6367 4.54427 24.1341 4.02083 24.7747 3.65625C25.4153 3.28646 26.1731 3.10156 27.0481 3.10156C27.9231 3.10156 28.6809 3.28125 29.3216 3.64062C29.9622 4 30.457 4.50781 30.8059 5.16406C31.1549 5.82031 31.3294 6.59115 31.3294 7.47656V8.27344H24.1341V6.66406H30.0169L28.7356 8.20312V7.10156C28.7356 6.65885 28.6679 6.28906 28.5325 5.99219C28.3971 5.6901 28.207 5.46094 27.9622 5.30469C27.7226 5.14844 27.4414 5.07031 27.1184 5.07031C26.7955 5.07031 26.5117 5.15104 26.2669 5.3125C26.0221 5.46875 25.8294 5.69792 25.6887 6C25.5533 6.30208 25.4856 6.66927 25.4856 7.10156V8.21875C25.4856 8.64062 25.5533 9.0026 25.6887 9.30469C25.8242 9.60677 26.0195 9.83854 26.2747 10C26.5351 10.1562 26.845 10.2344 27.2044 10.2344C27.5117 10.2344 27.7695 10.1875 27.9778 10.0938C28.1914 9.99479 28.358 9.88542 28.4778 9.76562C28.6028 9.64583 28.6835 9.54948 28.72 9.47656L28.7434 9.44531L31.2747 9.4375L31.2512 9.53125C31.194 9.78646 31.0768 10.0703 30.8997 10.3828C30.7278 10.6901 30.4804 10.9818 30.1575 11.2578C29.8398 11.5339 29.4335 11.7604 28.9387 11.9375C28.444 12.1146 27.8476 12.2031 27.1497 12.2031ZM31.2959 12V3.30469H34.0694V4.6875H34.2178C34.348 4.20833 34.5954 3.83594 34.96 3.57031C35.3298 3.30469 35.7907 3.17188 36.3428 3.17188C36.5147 3.17188 36.6814 3.1849 36.8428 3.21094C37.0043 3.23177 37.1527 3.26562 37.2881 3.3125V5.65625C37.1058 5.60417 36.9157 5.5651 36.7178 5.53906C36.5199 5.51302 36.3246 5.5 36.1319 5.5C35.6996 5.5 35.3298 5.57552 35.0225 5.72656C34.7152 5.8724 34.4782 6.08854 34.3116 6.375C34.1501 6.65625 34.0694 7 34.0694 7.40625V12H31.2959ZM40.7547 12.2031C39.8432 12.2031 39.0594 12.0208 38.4031 11.6562C37.7521 11.2865 37.2495 10.763 36.8953 10.0859C36.5411 9.40885 36.3641 8.59896 36.3641 7.65625V7.64844C36.3641 6.71094 36.5385 5.90365 36.8875 5.22656C37.2417 4.54427 37.7391 4.02083 38.3797 3.65625C39.0203 3.28646 39.7781 3.10156 40.6531 3.10156C41.5281 3.10156 42.2859 3.28125 42.9266 3.64062C43.5672 4 44.062 4.50781 44.4109 5.16406C44.7599 5.82031 44.9344 6.59115 44.9344 7.47656V8.27344H37.7391V6.66406H43.6219L42.3406 8.20312V7.10156C42.3406 6.65885 42.2729 6.28906 42.1375 5.99219C42.0021 5.6901 41.812 5.46094 41.5672 5.30469C41.3276 5.14844 41.0464 5.07031 40.7234 5.07031C40.4005 5.07031 40.1167 5.15104 39.8719 5.3125C39.6271 5.46875 39.4344 5.69792 39.2938 6C39.1583 6.30208 39.0906 6.66927 39.0906 7.10156V8.21875C39.0906 8.64062 39.1583 9.0026 39.2938 9.30469C39.4292 9.60677 39.6245 9.83854 39.8797 10C40.1401 10.1562 40.45 10.2344 40.8094 10.2344C41.1167 10.2344 41.3745 10.1875 41.5828 10.0938C41.7964 9.99479 41.963 9.88542 42.0828 9.76562C42.2078 9.64583 42.2885 9.54948 42.325 9.47656L42.3484 9.44531L44.8797 9.4375L44.8563 9.53125C44.799 9.78646 44.6818 10.0703 44.5047 10.3828C44.3328 10.6901 44.0854 10.9818 43.7625 11.2578C43.4448 11.5339 43.0385 11.7604 42.5438 11.9375C42.049 12.1146 41.4526 12.2031 40.7547 12.2031ZM47.2681 12.1328C46.716 12.1328 46.2291 12.0234 45.8072 11.8047C45.3853 11.5859 45.0546 11.2812 44.815 10.8906C44.5806 10.4948 44.4634 10.0339 44.4634 9.50781V9.49219C44.4634 8.96615 44.5962 8.51562 44.8619 8.14062C45.1327 7.76042 45.5259 7.46354 46.0416 7.25C46.5624 7.03646 47.1952 6.90625 47.94 6.85938L51.1978 6.66406V8.21875L48.3775 8.39844C47.9712 8.42448 47.6614 8.51562 47.4478 8.67188C47.2343 8.82812 47.1275 9.03646 47.1275 9.29688V9.3125C47.1275 9.58333 47.2343 9.79948 47.4478 9.96094C47.6614 10.1224 47.9426 10.2031 48.2916 10.2031C48.5832 10.2031 48.8436 10.1458 49.0728 10.0312C49.3072 9.91146 49.4921 9.7526 49.6275 9.55469C49.7681 9.35156 49.8384 9.125 49.8384 8.875V6.07031C49.8384 5.77344 49.7317 5.54427 49.5181 5.38281C49.3098 5.21615 49.0155 5.13281 48.6353 5.13281C48.2707 5.13281 47.9765 5.19271 47.7525 5.3125C47.5337 5.43229 47.3827 5.59896 47.2994 5.8125L47.2837 5.85156H44.7759L44.7837 5.75781C44.8358 5.22135 45.0285 4.75521 45.3619 4.35938C45.7004 3.96354 46.1614 3.65625 46.7447 3.4375C47.328 3.21354 48.0103 3.10156 48.7916 3.10156C49.5989 3.10156 50.2811 3.21875 50.8384 3.45312C51.4009 3.6875 51.828 4.02604 52.1197 4.46875C52.4114 4.91146 52.5572 5.44531 52.5572 6.07031V12H49.8384V10.9219H49.69C49.5598 11.1667 49.3749 11.3802 49.1353 11.5625C48.9009 11.7448 48.6223 11.8854 48.2994 11.9844C47.9817 12.0833 47.6379 12.1328 47.2681 12.1328ZM52.9847 12V0.0390625H55.7581V12H52.9847Z" fill="black"/>
</svg>
</div>
      <!-- Страница добавления -->
      <section id="add" class="page active">
        <h2>Добавить заказ</h2>
        <form id="orderForm">
          <label>Дата: <input type="date" name="date" required></label>
          <label>Название заказа: <input type="text" name="title" required></label>
          <label>Количество пакетов: <input type="number" name="packages" required></label>
          <label>Цена за пакет: <input type="number" name="price" value="1" step="0.01"></label>
          <button type="submit" style="width: 100%;">Сохранить</button>
        </form>
        <p id="status"></p>
      </section>

      <!-- Страница отчётов -->
      <section id="report" class="page">
        <h2>Сформировать отчёт</h2>
        <label>С <input type="date" id="startDate"></label>
        <label>По <input type="date" id="endDate"></label>
        <div class="button-container">
        <button onclick="getReport()">Сделать отчёт</button>
        </div>
         <div id="reportResult"></div>
         <div id="reportModal" class="modal">
    <div class="modal-content">
    </div>
</div>
      </section>

        <section id="ordersList" class="page">
        <h2>Список заказов</h2>
        <label>Выбери дату:</label>
        <input type="date" id="filterDate">
        <button onclick="loadOrders()">Показать</button>
        <div id="ordersContent">Нет данных</div>
    </section>

       
    </main>
  </div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
    // === Подключение к Supabase ===
    const { createClient } = window.supabase;
    const supabaseUrl = 'https://wagljnxlaehfjliwidqw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhZ2xqbnhsYWVoZmpsaXdpZHF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMzk2NzksImV4cCI6MjA3MjkxNTY3OX0.4Ys9NduopSkGEspG9L3pyOegdDTWqlb0SRfk8wCoJYQ'; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    // === Глобальные функции ===

    // Функция для переключения бокового меню
    function toggleMenu() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.overlay');
        const content = document.querySelector('.content');
        
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        content.classList.toggle('shifted');
    }

    // Функция для показа выбранной страницы
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
    }

    // Обработчик нажатия клавиши Escape для закрытия меню
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar.classList.contains('active')) {
                toggleMenu();
            }
        }
    });

    // === Сохранение нового заказа ===
    document.getElementById('orderForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const form = e.target;
        const date = form.date.value;
        const title = form.title.value;
        const packages = parseInt(form.packages.value, 10);
        const price = parseFloat(form.price.value);

        const { error } = await supabase
            .from('orders')
            .insert([{ date, title, packages, price }]);

        if (error) {
            document.getElementById('status').textContent = 'Ошибка сохранения!';
            console.error(error);
        } else {
            document.getElementById('status').textContent = 'Заказ сохранен!';
            form.reset();
            setTimeout(() => {
                document.getElementById('status').textContent = '';
            }, 2000);
        }
    });

    // === Загрузка и отображение списка заказов ===
    async function loadOrders() {
        const date = document.getElementById("filterDate").value;
        if (!date) {
            alert("Выбери дату!");
            return;
        }

        const { data, error } = await supabase
            .from("orders")
            .select("*")
            .eq("date", date)
            .order("id", { ascending: true }); // Сортируем по ID

        if (error) {
            console.error("Ошибка при загрузке заказов:", error);
            alert("Ошибка при загрузке данных.");
            return;
        }

        const ordersList = document.getElementById("ordersContent");
        if (!data || data.length === 0) {
            ordersList.innerHTML = "<p>Нет заказов за выбранную дату.</p>";
            return;
        }

        let html = "";
        data.forEach(order => {
            html += `
                <div class="order-item" data-id="${order.id}" data-title="${order.title}" data-packages="${order.packages}" data-price="${order.price}">
                    <div><strong>Название:</strong> ${order.title}</div>
                    <div><strong>Пакетов:</strong> ${order.packages}</div>
                    <div><strong>Цена:</strong>${parseFloat(order.price)}</div>
                    <div class="actions">
                        <button class="edit-btn">Редактировать</button>
                        <button class="delete-btn">Удалить</button>
                    </div>
                </div>
                <hr class="separator">`;
        });

        // Убираем последний разделитель для красоты
        if (data.length > 0) {
            ordersList.innerHTML = html.slice(0, html.lastIndexOf('<hr class="separator">'));
        } else {
            ordersList.innerHTML = html;
        }
    }

    // === Удаление заказа по ID ===
    async function deleteOrder(id) {
        if (!confirm("Вы уверены, что хотите удалить этот заказ?")) {
            return;
        }

        const { error } = await supabase
            .from("orders")
            .delete()
            .eq("id", id);

        if (error) {
            console.error("Ошибка при удалении заказа:", error);
            alert("Не удалось удалить заказ.");
            return;
        }
        
        alert("Заказ успешно удален!");
        loadOrders(); // Обновляем список заказов после удаления
    }

    // === Редактирование заказа ===
    async function editOrder(id, title, packages, price) {
        const newTitle = prompt("Название заказа:", title);
        if (newTitle === null) return;
        
        const newPackages = prompt("Количество пакетов:", packages);
        if (newPackages === null) return;
        
        const newPrice = prompt("Цена за пакет:", price);
        if (newPrice === null) return;

        const { error } = await supabase
            .from("orders")
            .update({ 
                title: newTitle, 
                packages: parseInt(newPackages, 10), 
                price: parseFloat(newPrice) 
            })
            .eq("id", id);

        if (error) {
            console.error("Ошибка при обновлении заказа:", error);
            alert("Не удалось обновить заказ.");
            return;
        }
        
        alert("Заказ успешно обновлен!");
        loadOrders(); // Обновляем список после редактирования
    }

    // === Получение данных для отчёта и отображение на странице ===
    async function getReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    let query = supabase.from('orders').select('*');

    if (startDate && endDate) {
        query = query.gte('date', startDate).lte('date', endDate);
    }

    const { data, error } = await query;

    if (error) {
        document.getElementById('reportResult').innerHTML = '<p>Ошибка при получении отчета.</p>';
        console.error("Ошибка при получении отчёта:", error);
        return;
    }

    if (!data || data.length === 0) {
        document.getElementById('reportResult').innerHTML = '<p>Нет данных за выбранный период.</p>';
        return;
    }

    let total = 0;
    let html = '<h3>Суммы по заказам:</h3>';
    data.forEach(order => {
        const sum = order.packages * order.price;
        total += sum;
        
        // Преобразуем дату из формата YYYY-MM-DD в DD.MM
        const dateParts = order.date.split('-');
        const formattedDate = `${dateParts[2]}.${dateParts[1]}`;

        html += `
    <div class="report-item">
        <span style="color: #666;">${formattedDate} </span>${order.title}<span style="color: #666;"> — </span>${order.packages}<span style="color: #666;"> × </span>${parseFloat(order.price)}<span style="color: #666;"> = </span>${parseFloat(sum)}
    </div>
    <hr class="separator">`;
    });
    
    html += `<p style="font-size: 20px"><b>Итого: ${parseFloat(total)} сом</b></p>`;

    document.getElementById('reportResult').innerHTML = html;
}

    // === Делегирование событий: устанавливается один раз ===
    document.addEventListener('DOMContentLoaded', () => {
        const ordersContent = document.getElementById("ordersContent");

        ordersContent.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-btn')) {
                const orderItem = event.target.closest('.order-item');
                const id = orderItem.dataset.id;
                const title = orderItem.dataset.title;
                const packages = orderItem.dataset.packages;
                const price = orderItem.dataset.price;
                editOrder(id, title, packages, price);
            }
        });

        ordersContent.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-btn')) {
                const id = event.target.closest('.order-item').dataset.id;
                deleteOrder(id);
            }
        });
    });
</script>

</body>
</html>